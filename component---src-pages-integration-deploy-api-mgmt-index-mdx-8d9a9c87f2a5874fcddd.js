(window.webpackJsonp=window.webpackJsonp||[]).push([[25],{"013z":function(e,t,n){"use strict";n("KKXr"),n("pIFo");var a=n("pOBw"),i=n("q1tI"),o=n.n(i),c=n("NmYn"),r=n.n(c),s=n("OKom"),l=n("k4MR"),p=n("TSYQ"),b=n.n(p),m=n("QH2O"),u=n("qKvR"),g=function(e){var t,n=e.title,a=e.tabs,i=void 0===a?[]:a;return Object(u.b)("div",{className:b()(m.pageHeader,(t={},t[m.withTabs]=i.length,t))},Object(u.b)("div",{className:"bx--grid"},Object(u.b)("div",{className:"bx--row"},Object(u.b)("div",{className:"bx--col-lg-12"},Object(u.b)("h1",{id:"page-title",className:m.text},n)))))},d=n("pEPl"),h=n("BAC9"),O=function(e){var t=e.relativePagePath,n=e.repository,a=d.data.site.siteMetadata.repository,i=n||a,o=i.baseUrl,c=i.subDirectory,r=o+"/edit/"+i.branch+c+"/src/pages"+t;return o?Object(u.b)("div",{className:"bx--row "+h.row},Object(u.b)("div",{className:"bx--col"},Object(u.b)("a",{className:h.link,href:r},"Edit this page on GitHub"))):null},j=n("FCXl"),f=(n("Oyvg"),n("Wbzz")),y=n("I8xM");var w=function(e){var t,n;function a(){return e.apply(this,arguments)||this}return n=e,(t=a).prototype=Object.create(n.prototype),t.prototype.constructor=t,t.__proto__=n,a.prototype.render=function(){var e=this.props,t=e.tabs,n=e.slug,a=n.split("/").filter(Boolean).slice(-1)[0],i=t.map((function(e){var t,i=r()(e,{lower:!0}),o=i===a,c=new RegExp(a+"(?!-)"),s=n.replace(c,i);return Object(u.b)("li",{key:e,className:b()((t={},t[y.selectedItem]=o,t),y.listItem)},Object(u.b)(f.Link,{className:y.link,to:""+s},e))}));return Object(u.b)("div",{className:y.tabsContainer},Object(u.b)("div",{className:"bx--grid"},Object(u.b)("div",{className:"bx--row"},Object(u.b)("div",{className:"bx--col-lg-12 bx--col-no-gutter"},Object(u.b)("nav",null,Object(u.b)("ul",{className:y.list},i))))))},a}(o.a.Component),N=n("MjG9");t.a=function(e){var t=e.pageContext,n=e.children,i=e.location,o=e.Title,c=t.frontmatter,p=void 0===c?{}:c,b=t.relativePagePath,m=t.titleType,d=p.tabs,h=p.title,f=p.theme,y=p.description,v=p.keywords,k=a.data.site.pathPrefix,S=k?i.pathname.replace(k,""):i.pathname,P=d?S.split("/").filter(Boolean).slice(-1)[0]||r()(d[0],{lower:!0}):"";return Object(u.b)(l.a,{tabs:d,homepage:!1,theme:f,pageTitle:h,pageDescription:y,pageKeywords:v,titleType:m},Object(u.b)(g,{title:o?Object(u.b)(o,null):h,label:"label",tabs:d}),d&&Object(u.b)(w,{slug:S,tabs:d,currentTab:P}),Object(u.b)(N.a,{padded:!0},n,Object(u.b)(O,{relativePagePath:b})),Object(u.b)(j.a,{pageContext:t,location:i,slug:S,tabs:d,currentTab:P}),Object(u.b)(s.a,null))}},KjPh:function(e,t,n){"use strict";n.r(t),n.d(t,"default",(function(){return s}));n("91GP"),n("rGqo"),n("yt8O"),n("Btvt"),n("RW0V"),n("q1tI");var a=n("7ljp"),i=n("013z");n("qKvR");function o(){return(o=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e}).apply(this,arguments)}var c={},r=i.a;function s(e){var t=e.components,n=function(e,t){if(null==e)return{};var n,a,i={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,["components"]);return Object(a.b)(r,o({},c,n,{components:t,mdxType:"MDXLayout"}),Object(a.b)("p",null,"This page contains guidance on how to configure the APIC release for both on-prem and ROKS."),Object(a.b)("h3",null,"Prepare endpoints"),Object(a.b)("p",null,"We have to define the endpoint for each of the APIC subsystems. We can “construct” the endpoints by adding descriptive “prefixes” to the proxy URL. In the sample described here, the proxy URL was ",Object(a.b)("inlineCode",{parentName:"p"},"icp-proxy.icp4i-6550a99fb8cff23207ccecc2183787a9-0001.us-east.containers.appdomain.cloud")," so we defined the endpoints as follows:"),Object(a.b)("p",null,"Management - all endpoints:"),Object(a.b)("pre",null,Object(a.b)("code",o({parentName:"pre"},{}),"mgmt.icp-proxy.icp4i-6550a99fb8cff23207ccecc2183787a9-0001.us-east.containers.appdomain.cloud\n")),Object(a.b)("p",null,"Gateway - API:"),Object(a.b)("pre",null,Object(a.b)("code",o({parentName:"pre"},{}),"gw.icp-proxy.icp4i-6550a99fb8cff23207ccecc2183787a9-0001.us-east.containers.appdomain.cloud\n")),Object(a.b)("p",null,"Gateway - service:"),Object(a.b)("pre",null,Object(a.b)("code",o({parentName:"pre"},{}),"gwd.icp-proxy.icp4i-6550a99fb8cff23207ccecc2183787a9-0001.us-east.containers.appdomain.cloud\n")),Object(a.b)("p",null,"Analytics - ingestion:"),Object(a.b)("pre",null,Object(a.b)("code",o({parentName:"pre"},{}),"ai.icp-proxy.icp4i-6550a99fb8cff23207ccecc2183787a9-0001.us-east.containers.appdomain.cloud\n")),Object(a.b)("p",null,"Analytics - client:"),Object(a.b)("pre",null,Object(a.b)("code",o({parentName:"pre"},{}),"ac.icp-proxy.icp4i-6550a99fb8cff23207ccecc2183787a9-0001.us-east.containers.appdomain.cloud\n")),Object(a.b)("p",null,"Portal - web"),Object(a.b)("pre",null,Object(a.b)("code",o({parentName:"pre"},{}),"portal.icp-proxy.icp4i-6550a99fb8cff23207ccecc2183787a9-0001.us-east.containers.appdomain.cloud\n")),Object(a.b)("p",null,"Portal - director:"),Object(a.b)("pre",null,Object(a.b)("code",o({parentName:"pre"},{}),"padmin.icp-proxy.icp4i-6550a99fb8cff23207ccecc2183787a9-0001.us-east.containers.appdomain.cloud\n")),Object(a.b)("h3",null,"Obtain the pull secret"),Object(a.b)("p",null,"To obtain the secret for pulling the image login to the OCP CLI and run:"),Object(a.b)("pre",null,Object(a.b)("code",o({parentName:"pre"},{}),"oc get secrets -n apic\n")),Object(a.b)("p",null,"For Offline Installs - The pull secret starts with ",Object(a.b)("strong",{parentName:"p"},"deployer-dockercfg"),", in our case it was:"),Object(a.b)("pre",null,Object(a.b)("code",o({parentName:"pre"},{}),"deployer-dockercfg-7mlqd\n")),Object(a.b)("p",null,"For Online/entitled Registry Installs - use the ",Object(a.b)("inlineCode",{parentName:"p"},"ibm-entitlement-key")," pull secret"),Object(a.b)("h3",null,"Create the TLS secret."),Object(a.b)("p",null,"The easiest way to accomplish this is to create the TLS Secret using the Visual Web Terminal inside of the Cloud Pak Foundation window.  To access this window do the following"),Object(a.b)("ol",null,Object(a.b)("li",{parentName:"ol"},"Via the Platform Navigator. Select the Hamburger menu, top left and then select ",Object(a.b)("strong",{parentName:"li"},"Cloud Pak Foundation"),Object(a.b)("img",o({parentName:"li"},{src:"8.common-cli.png",alt:null}))),Object(a.b)("li",{parentName:"ol"},"Select the Visual Web Terminal icon.  2nd Icon from the right (looks like the box)\n",Object(a.b)("img",o({parentName:"li"},{src:"9.cli2.png",alt:null}))),Object(a.b)("li",{parentName:"ol"},"The Visual Web Terminal will start and then once it connects to your cluster you can enter in commands.  Try to enter a command like ",Object(a.b)("inlineCode",{parentName:"li"},"helm ls"),".  You should see output like the following:\n",Object(a.b)("img",o({parentName:"li"},{src:"10.visual.png",alt:null}))),Object(a.b)("li",{parentName:"ol"},"Now you can run the following command to create the TLS secret:")),Object(a.b)("pre",null,Object(a.b)("code",o({parentName:"pre"},{}),"oc create secret generic apic-ent-helm-tls --from-file=cert.pem=$HOME/.helm/cert.pem --from-file=ca.pem=$HOME/.helm/ca.pem --from-file=key.pem=$HOME/.helm/key.pem -n apic\n")),Object(a.b)("p",null,"where ",Object(a.b)("strong",{parentName:"p"},"apic-ent-helm-tls")," is the name of the secret."),Object(a.b)("h3",null,"Increase vm.max_map_count"),Object(a.b)("p",null,"To check and increase ",Object(a.b)("inlineCode",{parentName:"p"},"vm.max_map_count")," we would need an ",Object(a.b)("em",{parentName:"p"},"ssh")," access to each of the cluster nodes."),Object(a.b)("p",null,"The alternative is to create a DaemonSet which will do that for us. Prepare the yaml file with the following content:"),Object(a.b)("pre",null,Object(a.b)("code",o({parentName:"pre"},{className:"language-yaml"}),"apiVersion: extensions/v1beta1\nkind: DaemonSet\nmetadata:\n  labels:\n    k8s-app: sysctl-conf\n  name: sysctl-conf\n  namespace: kube-system\nspec:\n  template:\n    metadata:\n      labels:\n        k8s-app: sysctl-conf\n    spec:\n      containers:\n      - command:\n        - sh\n        - -c\n        - sysctl -w vm.max_map_count=262144 && while true; do sleep 86400; done\n        image: busybox:1.26.2\n        name: sysctl-conf\n        resources:\n          limits:\n            cpu: 10m\n            memory: 50Mi\n          requests:\n            cpu: 10m\n            memory: 50Mi\n        securityContext:\n          privileged: true\n      terminationGracePeriodSeconds: 1\n")),Object(a.b)("p",null,"and run apply it with:"),Object(a.b)("pre",null,Object(a.b)("code",o({parentName:"pre"},{}),"oc apply -f sysctl-conf.yaml\n")),Object(a.b)("p",null,Object(a.b)("em",{parentName:"p"},"Note")," if you have done something similar for eventstreams, note that the required value of vm.max_map_count is higher than what was required"),Object(a.b)("h3",null,"Storage class"),Object(a.b)("p",null,"The ",Object(a.b)("strong",{parentName:"p"},"block storage class")," is needed for APIC.\nYou can obtain the class names with"),Object(a.b)("pre",null,Object(a.b)("code",o({parentName:"pre"},{}),"oc get storageclass\n")),Object(a.b)("p",null,"The follwing classes are available on ROKS:"),Object(a.b)("pre",null,Object(a.b)("code",o({parentName:"pre"},{}),"NAME                          PROVISIONER         AGE\ndefault                       ibm.io/ibmc-file    9d\nibmc-block-bronze (default)   ibm.io/ibmc-block   9d\nibmc-block-custom             ibm.io/ibmc-block   9d\nibmc-block-gold               ibm.io/ibmc-block   9d\nibmc-block-retain-bronze      ibm.io/ibmc-block   9d\nibmc-block-retain-custom      ibm.io/ibmc-block   9d\nibmc-block-retain-gold        ibm.io/ibmc-block   9d\nibmc-block-retain-silver      ibm.io/ibmc-block   9d\nibmc-block-silver             ibm.io/ibmc-block   9d\nibmc-file-bronze              ibm.io/ibmc-file    9d\nibmc-file-custom              ibm.io/ibmc-file    9d\nibmc-file-gold                ibm.io/ibmc-file    9d\nibmc-file-retain-bronze       ibm.io/ibmc-file    9d\nibmc-file-retain-custom       ibm.io/ibmc-file    9d\nibmc-file-retain-gold         ibm.io/ibmc-file    9d\nibmc-file-retain-silver       ibm.io/ibmc-file    9d\nibmc-file-silver              ibm.io/ibmc-file    9d\n")),Object(a.b)("p",null,"In our case, we decided to use ",Object(a.b)("inlineCode",{parentName:"p"},"ibmc-block-gold"),".  This will work with IBM Cloud based installs.  Offline Installs Require Ceph.  Other Clouds like AWS have their own block storage.  Be sure to check their documentation."),Object(a.b)("h3",null,"Create an instance"),Object(a.b)("ul",null,Object(a.b)("li",{parentName:"ul"},"Be sure to set permissions using the following.  Make sure you have changed context to the apic project via ",Object(a.b)("inlineCode",{parentName:"li"},"oc project apic"))),Object(a.b)("pre",null,Object(a.b)("code",o({parentName:"pre"},{}),"oc adm policy add-scc-to-group ibm-anyuid-scc system:serviceaccounts:apic\noc adm policy add-scc-to-group anyuid system:serviceaccounts:apic\n")),Object(a.b)("ul",null,Object(a.b)("li",{parentName:"ul"},Object(a.b)("p",{parentName:"li"},"Open platform navigator and select ",Object(a.b)("strong",{parentName:"p"},"API Connect")," / ",Object(a.b)("strong",{parentName:"p"},"Create instance"))),Object(a.b)("li",{parentName:"ul"},Object(a.b)("p",{parentName:"li"},"Click ",Object(a.b)("em",{parentName:"p"},"Continue"))),Object(a.b)("li",{parentName:"ul"},Object(a.b)("p",{parentName:"li"},"Define the helm release name, select ",Object(a.b)("strong",{parentName:"p"},"apic")," namespace and the local-cluster.")),Object(a.b)("li",{parentName:"ul"},Object(a.b)("p",{parentName:"li"},"Enter the registry secret name, helm TLS secret name and select storage class:")),Object(a.b)("li",{parentName:"ul"},Object(a.b)("p",{parentName:"li"},"Enter the management and portal endpoints:\n",Object(a.b)("img",o({parentName:"p"},{src:"/assets/img/integration/apic-roks/Snip20190909_16.png",alt:"Platform endpoints"})))),Object(a.b)("li",{parentName:"ul"},Object(a.b)("p",{parentName:"li"},"Scroll enter the analytics and gateway endpoints:\n",Object(a.b)("img",o({parentName:"p"},{src:"/assets/img/integration/apic-roks/Snip20190909_17.png",alt:"Gateway endpoints"})))),Object(a.b)("li",{parentName:"ul"},Object(a.b)("p",{parentName:"li"},"If not already, switch the view to show all parameters\n",Object(a.b)("img",o({parentName:"p"},{src:"/assets/img/integration/apic-roks/Snip20190909_17c.png",alt:"All params"})))),Object(a.b)("li",{parentName:"ul"},Object(a.b)("p",{parentName:"li"},"Find the ",Object(a.b)("em",{parentName:"p"},"Routing Type")," parameter. For running on OpenShift, the type must be ",Object(a.b)("strong",{parentName:"p"},"Route")," instead of the default ",Object(a.b)("em",{parentName:"p"},"Ingress"),".\n",Object(a.b)("img",o({parentName:"p"},{src:"/assets/img/integration/apic-roks/Snip20190909_17a.png",alt:"Routung type"})))),Object(a.b)("li",{parentName:"ul"},Object(a.b)("p",{parentName:"li"},"For the non-production installation, you may switch the mode to ",Object(a.b)("strong",{parentName:"p"},"dev"),"\n",Object(a.b)("img",o({parentName:"p"},{src:"/assets/img/integration/apic-roks/Snip20190909_17d.png",alt:"Mode"})))),Object(a.b)("li",{parentName:"ul"},Object(a.b)("p",{parentName:"li"},"and the number of gateway replicas to ",Object(a.b)("strong",{parentName:"p"},"1"),"\n",Object(a.b)("img",o({parentName:"p"},{src:"/assets/img/integration/apic-roks/Snip20190909_17b.png",alt:"Replicas"})))),Object(a.b)("li",{parentName:"ul"},Object(a.b)("p",{parentName:"li"},"Click on ",Object(a.b)("strong",{parentName:"p"},"Install"),", the confirmation message will appear:\n",Object(a.b)("img",o({parentName:"p"},{src:"/assets/img/integration/apic-roks/Snip20190909_19.png",alt:"Install"})))),Object(a.b)("li",{parentName:"ul"},Object(a.b)("p",{parentName:"li"},"You can check the status of the pods with the command:"))),Object(a.b)("pre",null,Object(a.b)("code",o({parentName:"pre"},{}),"oc get pods -n apic\n")),Object(a.b)("ul",null,Object(a.b)("li",{parentName:"ul"},"When deployment is completed, all pods must be in ",Object(a.b)("strong",{parentName:"li"},"Running")," or ",Object(a.b)("strong",{parentName:"li"},"Completed")," state.  This entire process could take over an hour to complete.  The list of pods should look similar to this one:")),Object(a.b)("pre",null,Object(a.b)("code",o({parentName:"pre"},{}),"### Configure APIC to work with Tracing\n\n1. Near the end of the install of APIC, a job will be created that has the name `odtracing.registration`.  This job will not complete until the Registration is completed inside of the Tracing capability.\n2. What will happen is that a request will be created inside of tracing that you need to act upon.  Navigate to the Platform Navigator and via the Hamburger menu select Tracing and then when the window pops out select the name of your tracing instance which should be called `tracing`\n![](13.tracing-nav.png)\n3. Within tracing, select the `Manage` icon from the menu.  Looks like a cog wheel.\n![](14.tracing-from-menu.png)\n4. Click on the `Registration Requests` icon.\n5. You should see a new registration request for your APIC install.  Click the `approve` link\n6. You will see a pop up window with some lines to copy to your clipboard.  Click the 2 boxes icon in the top right icon to copy the commands required.\n![](15.process-request.png)\n7. Ensuring you have an active `oc` session and in the `apic` project.  Paste the commands to the window and it will run then and finish the processing.\n8. If you are slow in doing the steps above.  It is possible you might see the `odtracing.registration` job fail.  No worries.  Once you complete the pasting of the commands to create your secret, the job will re-create itself.\n\n\n### SMTP server\n\nIn order to configure the API Connect, we need a SMTP server. If we don't have one, we can run a developer type SMTP Service.  `mailtrap.io` is a good one.\n\n\n### Configuring the API Connect\n\n- You can access your new install by starting from the Platform Navigator\n\n- Select IBM Cloud Private user, default username and password in this case are admin/admin\n![Login CMC](/assets/img/integration/apic-roks/Snip20190910_32.png)\n\n- Under **Resources/Notifications** define the SMTP server\n![SMTP](/assets/img/integration/apic-roks/Snip20190910_51.png)\n\n- For our Mailtrap server enter ClusterIP address and port:\n![SMTP](/assets/img/integration/apic-roks/Snip20190910_53.png)\n\n- Under **Settings/Notifications** edit the sender email server:\n![SMTP](/assets/img/integration/apic-roks/Snip20190910_56.png)\n\n- And select the SMTP server defined under resources:\n![email](/assets/img/integration/apic-roks/Snip20190910_57.png)\n\n- Start with the **Topology** configuration\n![Topology](/assets/img/integration/apic-roks/Snip20190910_34.png)\n\n- Register service:\n![Register Service](/assets/img/integration/apic-roks/Snip20190910_35.png)\n\n- Start with the Gateway, select the version that you defined under the Helm release properties when you started creating the instance. In our case it was V5 compatible version:\n![Gateway](/assets/img/integration/apic-roks/Snip20190910_36.png)\n\n- Give some name to the service (e.g. **gateway1**) enter the **endpoints** and click on **Save**:\n![Gateway](/assets/img/integration/apic-roks/Snip20190910_38.png)\n\n- The confirmation message should appear:\n![Gateway](/assets/img/integration/apic-roks/Snip20190910_40.png)\n\n- Click on *Register service* again and select Analytics:\n![Analytics](/assets/img/integration/apic-roks/Snip20190910_43.png)\n\n- Give some name to the service, enter Management endpoint (the one that you defined for **analytics client**) and click **Save**\n![Analytics](/assets/img/integration/apic-roks/Snip20190910_44.png)\n\n- The confirmation appears:\n![Analytics](/assets/img/integration/apic-roks/Snip20190910_46.png)\n\n- Repeat the same with portal:\n![Portal](/assets/img/integration/apic-roks/Snip20190910_48.png)\n\n- The confirmation appears again:\n![Portal](/assets/img/integration/apic-roks/Snip20190910_62.png)\n\n- Click on **Associate Analytics Service** to associate analytics with the gateway:\n![Associate analytics](/assets/img/integration/apic-roks/Snip20190910_63.png)\n\n- Select the analytics service:\n![Associate analytics](/assets/img/integration/apic-roks/Snip20190910_64.png)\n\n- Click on **Provider organizations** and add new organization:\n![ProvOrg](/assets/img/integration/apic-roks/Snip20190910_66.png)\n\n- Give some name to the organization:\n![ProvOrg](/assets/img/integration/apic-roks/Snip20190910_67.png)\n\n- Define the owner\n![ProvOrg](/assets/img/integration/apic-roks/Snip20190910_68.png)\n\n- After you submit the organization will appear on the list:\n![ProvOrg](/assets/img/integration/apic-roks/Snip20190910_69.png)\n\n- Navigate to the API Manager, in our case the endpoint was:\nhttps://mgmt.icp-proxy.icp4i-6550a99fb8cff23207ccecc2183787a9-0001.us-east.containers.appdomain.cloud/manage\n\n- Login as the owner (defined in the previous step), the API Manager page should open:\n![API Mgr](/assets/img/integration/apic-roks/Snip20190910_70.png)\n\n- You can navigate to the catalog:\n![Sandbox](/assets/img/integration/apic-roks/Snip20190910_71.png)\n\n- and create portal\n![Create portal](/assets/img/integration/apic-roks/Snip20190910_73.png)\n\n- You can also assign the gateway to the catalog\n![Catalog](/assets/img/integration/apic-roks/Snip20190910_79.png)\n\nWith that, your API Connect instance is ready for usage. \n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n---\n\n\nexport const _frontmatter = {}\n")))}s.isMDXComponent=!0},pEPl:function(e){e.exports=JSON.parse('{"data":{"site":{"siteMetadata":{"repository":{"baseUrl":"https://ocp43.cloudpak8s.io","subDirectory":"/","branch":"master"}}}}}')},pOBw:function(e){e.exports=JSON.parse('{"data":{"site":{"pathPrefix":""}}}')}}]);
//# sourceMappingURL=component---src-pages-integration-deploy-api-mgmt-index-mdx-8d9a9c87f2a5874fcddd.js.map